{"version":3,"sources":["../../src/utils.ts"],"names":["MAX_LATITUDE","createDeckInstance","map","overlay","deck","props","userData","_googleMap","destroyDeckInstance","eventListeners","click","rightclick","dblclick","mousemove","mouseout","newDeck","Deck","useDevicePixels","interleaved","style","pointerEvents","parent","getContainer","initialViewState","longitude","latitude","zoom","controller","eventType","addListener","evt","handleMouseEvent","_eventListeners","container","document","createElement","position","Object","assign","getPanes","overlayLayer","appendChild","getMap","getDiv","remove","finalize","getViewPropsFromOverlay","getMapSize","width","height","projection","getProjection","bounds","getBounds","left","top","ne","getNorthEast","sw","getSouthWest","topRight","fromLatLngToDivPixel","bottomLeft","centerLngLat","pixelToLngLat","centerH","google","maps","LatLng","centerContainerPx","fromLatLngToContainerPixel","centerDivPx","leftOffset","Math","round","x","topOffset","y","topLngLat","bottomLngLat","abs","center","centerPx","delta","Vector2","sub","bearing","verticalAngle","PI","heading","getHeading","getZoom","scale","viewDiagonal","len","mapDiagonal","log2","pitch","getTilt","getViewPropsFromCoordinateTransformer","transformer","getCameraParams","tilt","fovy","aspect","near","far","projectionMatrix","Matrix4","perspective","focalDistance","viewState","altitude","lat","lng","repeat","firstChild","offsetWidth","offsetHeight","point","Point","latLng","fromContainerPixelToLatLng","getEventPixel","event","pixel","getViewports","project","type","isInitialized","mockEvent","offsetCenter","srcEvent","tapCount","_onPointerDown","_onEvent","_onPointerMove"],"mappings":"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","sourcesContent":["/* global google, document */\nimport {Deck} from '@deck.gl/core';\nimport {Matrix4, Vector2} from '@math.gl/core';\nimport type {MjolnirGestureEvent, MjolnirPointerEvent} from 'mjolnir.js';\n\n// https://en.wikipedia.org/wiki/Web_Mercator_projection#Formulas\nconst MAX_LATITUDE = 85.05113;\n\ntype UserData = {\n  _googleMap: google.maps.Map;\n  _eventListeners: Record<string, google.maps.MapsEventListener | null>;\n};\n\n/**\n * Get a new deck instance\n * @param map (google.maps.Map) - The parent Map instance\n * @param overlay (google.maps.OverlayView) - A maps Overlay instance\n * @param [deck] (Deck) - a previously created instances\n */\nexport function createDeckInstance(\n  map: google.maps.Map,\n  overlay: google.maps.OverlayView | google.maps.WebGLOverlayView,\n  deck: Deck | null | undefined,\n  props\n): Deck {\n  if (deck) {\n    if (deck.userData._googleMap === map) {\n      return deck;\n    }\n    // deck instance was created for a different map\n    destroyDeckInstance(deck);\n  }\n\n  const eventListeners = {\n    click: null,\n    rightclick: null,\n    dblclick: null,\n    mousemove: null,\n    mouseout: null\n  };\n\n  const newDeck = new Deck({\n    ...props,\n    useDevicePixels: props.interleaved ? true : props.useDevicePixels,\n    style: props.interleaved ? null : {pointerEvents: 'none'},\n    parent: getContainer(overlay, props.style),\n    initialViewState: {\n      longitude: 0,\n      latitude: 0,\n      zoom: 1\n    },\n    controller: false\n  });\n\n  // Register event listeners\n  for (const eventType in eventListeners) {\n    eventListeners[eventType] = map.addListener(eventType, evt =>\n      handleMouseEvent(newDeck, eventType, evt)\n    );\n  }\n\n  // Attach userData directly to Deck instance\n  (newDeck.userData as UserData)._googleMap = map;\n  (newDeck.userData as UserData)._eventListeners = eventListeners;\n\n  return newDeck;\n}\n\n// Create a container that will host the deck canvas and tooltip\nfunction getContainer(\n  overlay: google.maps.OverlayView | google.maps.WebGLOverlayView,\n  style?: Partial<CSSStyleDeclaration>\n): HTMLElement {\n  const container = document.createElement('div');\n  container.style.position = 'absolute';\n  Object.assign(container.style, style);\n\n  // The DOM structure has a different structure depending on whether\n  // the Google map is rendered as vector or raster\n  if ('getPanes' in overlay) {\n    overlay.getPanes()?.overlayLayer.appendChild(container);\n  } else {\n    overlay.getMap()?.getDiv().appendChild(container);\n  }\n  return container;\n}\n\n/**\n * Safely remove a deck instance\n * @param deck (Deck) - a previously created instances\n */\nexport function destroyDeckInstance(deck: Deck) {\n  const {_eventListeners: eventListeners} = deck.userData;\n\n  // Unregister event listeners\n  for (const eventType in eventListeners) {\n    // Check that event listener was set before trying to remove.\n    if (eventListeners[eventType]) {\n      eventListeners[eventType].remove();\n    }\n  }\n\n  deck.finalize();\n}\n\n/* eslint-disable max-statements */\n/**\n * Get the current view state\n * @param map (google.maps.Map) - The parent Map instance\n * @param overlay (google.maps.OverlayView) - A maps Overlay instance\n */\n// eslint-disable-next-line complexity\nexport function getViewPropsFromOverlay(map: google.maps.Map, overlay: google.maps.OverlayView) {\n  const {width, height} = getMapSize(map);\n\n  // Canvas position relative to draggable map's container depends on\n  // overlayView's projection, not the map's. Have to use the center of the\n  // map for this, not the top left, for the same reason as above.\n  const projection = overlay.getProjection();\n\n  const bounds = map.getBounds();\n  if (!bounds) {\n    return {width, height, left: 0, top: 0};\n  }\n\n  const ne = bounds.getNorthEast();\n  const sw = bounds.getSouthWest();\n  const topRight = projection.fromLatLngToDivPixel(ne);\n  const bottomLeft = projection.fromLatLngToDivPixel(sw);\n\n  // google maps places overlays in a container anchored at the map center.\n  // the container CSS is manipulated during dragging.\n  // We need to update left/top of the deck canvas to match the base map.\n  const centerLngLat = pixelToLngLat(projection, width / 2, height / 2);\n  const centerH = new google.maps.LatLng(0, centerLngLat[0]);\n  const centerContainerPx = projection.fromLatLngToContainerPixel(centerH);\n  const centerDivPx = projection.fromLatLngToDivPixel(centerH);\n\n  if (!topRight || !bottomLeft || !centerDivPx || !centerContainerPx) {\n    return {width, height, left: 0, top: 0};\n  }\n  const leftOffset = Math.round(centerDivPx.x - centerContainerPx.x);\n  let topOffset = centerDivPx.y - centerContainerPx.y;\n\n  const topLngLat = pixelToLngLat(projection, width / 2, 0);\n  const bottomLngLat = pixelToLngLat(projection, width / 2, height);\n\n  // Compute fractional center.\n  let latitude = centerLngLat[1];\n  const longitude = centerLngLat[0];\n\n  // Adjust vertical offset - limit latitude\n  if (Math.abs(latitude) > MAX_LATITUDE) {\n    latitude = latitude > 0 ? MAX_LATITUDE : -MAX_LATITUDE;\n    const center = new google.maps.LatLng(latitude, longitude);\n    const centerPx = projection.fromLatLngToContainerPixel(center);\n    // @ts-ignore (TS2531) Object is possibly 'null'\n    topOffset += centerPx.y - height / 2;\n  }\n  topOffset = Math.round(topOffset);\n\n  // Compute fractional bearing\n  const delta = new Vector2(topLngLat).sub(bottomLngLat);\n  let bearing = (180 * delta.verticalAngle()) / Math.PI;\n  if (bearing < 0) bearing += 360;\n\n  // Maps sometimes returns undefined instead of 0\n  const heading = map.getHeading() || 0;\n\n  let zoom = (map.getZoom() as number) - 1;\n\n  let scale;\n\n  if (bearing === 0) {\n    // At full world view (always unrotated) simply compare height, as diagonal\n    // is incorrect due to multiple world copies\n    scale = height ? (bottomLeft.y - topRight.y) / height : 1;\n  } else if (bearing === heading) {\n    // Fractional zoom calculation only correct when bearing is not animating\n    const viewDiagonal = new Vector2([topRight.x, topRight.y])\n      .sub([bottomLeft.x, bottomLeft.y])\n      .len();\n    const mapDiagonal = new Vector2([width, -height]).len();\n    scale = mapDiagonal ? viewDiagonal / mapDiagonal : 1;\n  }\n\n  // When resizing aggressively, occasionally ne and sw are the same points\n  // See https://github.com/visgl/deck.gl/issues/4218\n  zoom += Math.log2(scale || 1);\n\n  return {\n    width,\n    height,\n    left: leftOffset,\n    top: topOffset,\n    zoom,\n    bearing,\n    pitch: map.getTilt(),\n    latitude,\n    longitude\n  };\n}\n\n/* eslint-enable max-statements */\n\n/**\n * Get the current view state\n * @param map (google.maps.Map) - The parent Map instance\n * @param transformer (google.maps.CoordinateTransformer) - A CoordinateTransformer instance\n */\nexport function getViewPropsFromCoordinateTransformer(\n  map: google.maps.Map,\n  transformer: google.maps.CoordinateTransformer\n) {\n  const {width, height} = getMapSize(map);\n  const {center, heading: bearing, tilt: pitch, zoom} = transformer.getCameraParams();\n\n  // Match Google projection matrix\n  const fovy = 25;\n  const aspect = height ? width / height : 1;\n\n  // Match depth range (crucial for correct z-sorting)\n  const near = 0.75;\n  const far = 300000000000000;\n  // const far = Infinity;\n\n  const projectionMatrix = new Matrix4().perspective({\n    fovy: (fovy * Math.PI) / 180,\n    aspect,\n    near,\n    far\n  });\n  const focalDistance = 0.5 * projectionMatrix[5];\n\n  return {\n    width,\n    height,\n    viewState: {\n      altitude: focalDistance,\n      bearing,\n      latitude: center.lat(),\n      longitude: center.lng(),\n      pitch,\n      projectionMatrix,\n      repeat: true,\n      zoom: zoom - 1\n    }\n  };\n}\n\nfunction getMapSize(map: google.maps.Map): {width: number; height: number} {\n  // The map fills the container div unless it's in fullscreen mode\n  // at which point the first child of the container is promoted\n  const container = map.getDiv().firstChild as HTMLElement | null;\n  return {\n    // @ts-ignore (TS2531) Object is possibly 'null'\n    width: container.offsetWidth,\n    // @ts-ignore (TS2531) Object is possibly 'null'\n    height: container.offsetHeight\n  };\n}\n\nfunction pixelToLngLat(\n  projection: google.maps.MapCanvasProjection,\n  x: number,\n  y: number\n): [longitude: number, latitude: number] {\n  const point = new google.maps.Point(x, y);\n  const latLng = projection.fromContainerPixelToLatLng(point);\n  // @ts-ignore (TS2531) Object is possibly 'null'\n  return [latLng.lng(), latLng.lat()];\n}\n\nfunction getEventPixel(event, deck: Deck): {x: number; y: number} {\n  if (event.pixel) {\n    return event.pixel;\n  }\n  // event.pixel may not exist when clicking on a POI\n  // https://developers.google.com/maps/documentation/javascript/reference/map#MouseEvent\n  const point = deck.getViewports()[0].project([event.latLng.lng(), event.latLng.lat()]);\n  return {\n    x: point[0],\n    y: point[1]\n  };\n}\n\n// Triggers picking on a mouse event\nfunction handleMouseEvent(deck: Deck, type: string, event) {\n  if (!deck.isInitialized) {\n    return;\n  }\n\n  const mockEvent: Record<string, any> = {\n    type,\n    offsetCenter: getEventPixel(event, deck),\n    srcEvent: event\n  };\n\n  switch (type) {\n    case 'click':\n    case 'rightclick':\n      mockEvent.type = 'click';\n      mockEvent.tapCount = 1;\n      // Hack: because we do not listen to pointer down, perform picking now\n      deck._onPointerDown(mockEvent as MjolnirPointerEvent);\n      deck._onEvent(mockEvent as MjolnirGestureEvent);\n      break;\n\n    case 'dblclick':\n      mockEvent.type = 'click';\n      mockEvent.tapCount = 2;\n      deck._onEvent(mockEvent as MjolnirGestureEvent);\n      break;\n\n    case 'mousemove':\n      mockEvent.type = 'pointermove';\n      deck._onPointerMove(mockEvent as MjolnirPointerEvent);\n      break;\n\n    case 'mouseout':\n      mockEvent.type = 'pointerleave';\n      deck._onPointerMove(mockEvent as MjolnirPointerEvent);\n      break;\n\n    default:\n      return;\n  }\n}\n"],"file":"utils.js"}