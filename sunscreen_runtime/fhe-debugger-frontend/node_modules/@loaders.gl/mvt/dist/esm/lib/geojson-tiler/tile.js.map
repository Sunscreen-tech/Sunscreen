{"version":3,"file":"tile.js","names":["createTile","features","z","tx","ty","options","tolerance","maxZoom","extent","tile","numPoints","numSimplified","numFeatures","length","source","x","y","transformed","minX","minY","maxX","maxY","feature","addFeature","geom","geometry","type","simplified","Math","min","max","i","push","addLine","k","polygon","tags","lineMetrics","key","mapbox_clip_start","start","size","mapbox_clip_end","end","tileFeature","id","result","isPolygon","isOuter","sqTolerance","ring","rewind","clockwise","area","j","len"],"sources":["../../../../src/lib/geojson-tiler/tile.ts"],"sourcesContent":["// loaders.gl, MIT license\n// Forked from https://github.com/mapbox/geojson-vt under compatible ISC license\n\n// import type {Feature} from '@loaders.gl/schema';\n\nexport type GeoJSONTileFeature = {\n  type: any;\n  geometry: any;\n\n  // book keeping\n  id?: string;\n  tags?: string[];\n\n  // spatial extents\n  minX: number;\n  maxX: number;\n  minY: number;\n  maxY: number;\n};\n\nexport type GeoJSONTile = {\n  features: GeoJSONTileFeature[]; // Feature[]; Doesn't seem JSON compatible??\n  type?: number;\n  tags?: Record<string, string>;\n\n  // tile coordinates\n  x: number;\n  y: number;\n  z: number;\n\n  // spatial extents\n  minX: number;\n  maxX: number;\n  minY: number;\n  maxY: number;\n\n  transformed: boolean;\n  numPoints: number;\n  numSimplified: number;\n  numFeatures: number;\n  source: any | null;\n};\n\nexport type CreateTileOptions = {\n  maxZoom?: number;\n  tolerance: number;\n  extent: number;\n  lineMetrics: boolean;\n};\n\n/**\n * Create a tile from features and tile index\n */\nexport function createTile(features: any[], z, tx, ty, options: CreateTileOptions): GeoJSONTile {\n  const tolerance = z === options.maxZoom ? 0 : options.tolerance / ((1 << z) * options.extent);\n  const tile: GeoJSONTile = {\n    features: [],\n    numPoints: 0,\n    numSimplified: 0,\n    numFeatures: features.length,\n    source: null,\n    x: tx,\n    y: ty,\n    z,\n    transformed: false,\n    minX: 2,\n    minY: 1,\n    maxX: -1,\n    maxY: 0\n  };\n  for (const feature of features) {\n    addFeature(tile, feature, tolerance, options);\n  }\n  return tile;\n}\n\n// eslint-disable-next-line complexity, max-statements\nfunction addFeature(tile: GeoJSONTile, feature, tolerance: number, options: CreateTileOptions) {\n  const geom = feature.geometry;\n  const type = feature.type;\n  const simplified: number[] = [];\n\n  tile.minX = Math.min(tile.minX, feature.minX);\n  tile.minY = Math.min(tile.minY, feature.minY);\n  tile.maxX = Math.max(tile.maxX, feature.maxX);\n  tile.maxY = Math.max(tile.maxY, feature.maxY);\n\n  if (type === 'Point' || type === 'MultiPoint') {\n    for (let i = 0; i < geom.length; i += 3) {\n      simplified.push(geom[i], geom[i + 1]);\n      tile.numPoints++;\n      tile.numSimplified++;\n    }\n  } else if (type === 'LineString') {\n    addLine(simplified, geom, tile, tolerance, false, false);\n  } else if (type === 'MultiLineString' || type === 'Polygon') {\n    for (let i = 0; i < geom.length; i++) {\n      addLine(simplified, geom[i], tile, tolerance, type === 'Polygon', i === 0);\n    }\n  } else if (type === 'MultiPolygon') {\n    for (let k = 0; k < geom.length; k++) {\n      const polygon = geom[k];\n      for (let i = 0; i < polygon.length; i++) {\n        addLine(simplified, polygon[i], tile, tolerance, true, i === 0);\n      }\n    }\n  }\n\n  if (simplified.length) {\n    let tags = feature.tags || null;\n\n    if (type === 'LineString' && options.lineMetrics) {\n      tags = {};\n      for (const key in feature.tags) tags[key] = feature.tags[key];\n      // eslint-disable-next-line camelcase\n      tags.mapbox_clip_start = geom.start / geom.size;\n      // eslint-disable-next-line camelcase\n      tags.mapbox_clip_end = geom.end / geom.size;\n    }\n\n    // @ts-expect-error TODO - create sub type?\n    const tileFeature: GeoJSONTileFeature = {\n      geometry: simplified,\n      type:\n        type === 'Polygon' || type === 'MultiPolygon'\n          ? 3\n          : type === 'LineString' || type === 'MultiLineString'\n            ? 2\n            : 1,\n      tags\n    };\n    if (feature.id !== null) {\n      tileFeature.id = feature.id;\n    }\n    tile.features.push(tileFeature);\n  }\n}\n\n// eslint-disable-next-line max-params, max-statements\nfunction addLine(\n  result,\n  geom,\n  tile: GeoJSONTile,\n  tolerance: number,\n  isPolygon: boolean,\n  isOuter: boolean\n): void {\n  const sqTolerance = tolerance * tolerance;\n\n  if (tolerance > 0 && geom.size < (isPolygon ? sqTolerance : tolerance)) {\n    tile.numPoints += geom.length / 3;\n    return;\n  }\n\n  const ring: number[] = [];\n\n  for (let i = 0; i < geom.length; i += 3) {\n    if (tolerance === 0 || geom[i + 2] > sqTolerance) {\n      tile.numSimplified++;\n      ring.push(geom[i], geom[i + 1]);\n    }\n    tile.numPoints++;\n  }\n\n  if (isPolygon) rewind(ring, isOuter);\n\n  result.push(ring);\n}\n\nfunction rewind(ring: number[], clockwise?: boolean): void {\n  let area = 0;\n  for (let i = 0, j = ring.length - 2; i < ring.length; j = i, i += 2) {\n    area += (ring[i] - ring[j]) * (ring[i + 1] + ring[j + 1]);\n  }\n  if (area > 0 === clockwise) {\n    for (let i = 0, len = ring.length; i < len / 2; i += 2) {\n      const x = ring[i];\n      const y = ring[i + 1];\n      ring[i] = ring[len - 2 - i];\n      ring[i + 1] = ring[len - 1 - i];\n      ring[len - 2 - i] = x;\n      ring[len - 1 - i] = y;\n    }\n  }\n}\n"],"mappings":"AAqDA,OAAO,SAASA,UAAUA,CAACC,QAAe,EAAEC,CAAC,EAAEC,EAAE,EAAEC,EAAE,EAAEC,OAA0B,EAAe;EAC9F,MAAMC,SAAS,GAAGJ,CAAC,KAAKG,OAAO,CAACE,OAAO,GAAG,CAAC,GAAGF,OAAO,CAACC,SAAS,IAAI,CAAC,CAAC,IAAIJ,CAAC,IAAIG,OAAO,CAACG,MAAM,CAAC;EAC7F,MAAMC,IAAiB,GAAG;IACxBR,QAAQ,EAAE,EAAE;IACZS,SAAS,EAAE,CAAC;IACZC,aAAa,EAAE,CAAC;IAChBC,WAAW,EAAEX,QAAQ,CAACY,MAAM;IAC5BC,MAAM,EAAE,IAAI;IACZC,CAAC,EAAEZ,EAAE;IACLa,CAAC,EAAEZ,EAAE;IACLF,CAAC;IACDe,WAAW,EAAE,KAAK;IAClBC,IAAI,EAAE,CAAC;IACPC,IAAI,EAAE,CAAC;IACPC,IAAI,EAAE,CAAC,CAAC;IACRC,IAAI,EAAE;EACR,CAAC;EACD,KAAK,MAAMC,OAAO,IAAIrB,QAAQ,EAAE;IAC9BsB,UAAU,CAACd,IAAI,EAAEa,OAAO,EAAEhB,SAAS,EAAED,OAAO,CAAC;EAC/C;EACA,OAAOI,IAAI;AACb;AAGA,SAASc,UAAUA,CAACd,IAAiB,EAAEa,OAAO,EAAEhB,SAAiB,EAAED,OAA0B,EAAE;EAC7F,MAAMmB,IAAI,GAAGF,OAAO,CAACG,QAAQ;EAC7B,MAAMC,IAAI,GAAGJ,OAAO,CAACI,IAAI;EACzB,MAAMC,UAAoB,GAAG,EAAE;EAE/BlB,IAAI,CAACS,IAAI,GAAGU,IAAI,CAACC,GAAG,CAACpB,IAAI,CAACS,IAAI,EAAEI,OAAO,CAACJ,IAAI,CAAC;EAC7CT,IAAI,CAACU,IAAI,GAAGS,IAAI,CAACC,GAAG,CAACpB,IAAI,CAACU,IAAI,EAAEG,OAAO,CAACH,IAAI,CAAC;EAC7CV,IAAI,CAACW,IAAI,GAAGQ,IAAI,CAACE,GAAG,CAACrB,IAAI,CAACW,IAAI,EAAEE,OAAO,CAACF,IAAI,CAAC;EAC7CX,IAAI,CAACY,IAAI,GAAGO,IAAI,CAACE,GAAG,CAACrB,IAAI,CAACY,IAAI,EAAEC,OAAO,CAACD,IAAI,CAAC;EAE7C,IAAIK,IAAI,KAAK,OAAO,IAAIA,IAAI,KAAK,YAAY,EAAE;IAC7C,KAAK,IAAIK,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGP,IAAI,CAACX,MAAM,EAAEkB,CAAC,IAAI,CAAC,EAAE;MACvCJ,UAAU,CAACK,IAAI,CAACR,IAAI,CAACO,CAAC,CAAC,EAAEP,IAAI,CAACO,CAAC,GAAG,CAAC,CAAC,CAAC;MACrCtB,IAAI,CAACC,SAAS,EAAE;MAChBD,IAAI,CAACE,aAAa,EAAE;IACtB;EACF,CAAC,MAAM,IAAIe,IAAI,KAAK,YAAY,EAAE;IAChCO,OAAO,CAACN,UAAU,EAAEH,IAAI,EAAEf,IAAI,EAAEH,SAAS,EAAE,KAAK,EAAE,KAAK,CAAC;EAC1D,CAAC,MAAM,IAAIoB,IAAI,KAAK,iBAAiB,IAAIA,IAAI,KAAK,SAAS,EAAE;IAC3D,KAAK,IAAIK,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGP,IAAI,CAACX,MAAM,EAAEkB,CAAC,EAAE,EAAE;MACpCE,OAAO,CAACN,UAAU,EAAEH,IAAI,CAACO,CAAC,CAAC,EAAEtB,IAAI,EAAEH,SAAS,EAAEoB,IAAI,KAAK,SAAS,EAAEK,CAAC,KAAK,CAAC,CAAC;IAC5E;EACF,CAAC,MAAM,IAAIL,IAAI,KAAK,cAAc,EAAE;IAClC,KAAK,IAAIQ,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGV,IAAI,CAACX,MAAM,EAAEqB,CAAC,EAAE,EAAE;MACpC,MAAMC,OAAO,GAAGX,IAAI,CAACU,CAAC,CAAC;MACvB,KAAK,IAAIH,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGI,OAAO,CAACtB,MAAM,EAAEkB,CAAC,EAAE,EAAE;QACvCE,OAAO,CAACN,UAAU,EAAEQ,OAAO,CAACJ,CAAC,CAAC,EAAEtB,IAAI,EAAEH,SAAS,EAAE,IAAI,EAAEyB,CAAC,KAAK,CAAC,CAAC;MACjE;IACF;EACF;EAEA,IAAIJ,UAAU,CAACd,MAAM,EAAE;IACrB,IAAIuB,IAAI,GAAGd,OAAO,CAACc,IAAI,IAAI,IAAI;IAE/B,IAAIV,IAAI,KAAK,YAAY,IAAIrB,OAAO,CAACgC,WAAW,EAAE;MAChDD,IAAI,GAAG,CAAC,CAAC;MACT,KAAK,MAAME,GAAG,IAAIhB,OAAO,CAACc,IAAI,EAAEA,IAAI,CAACE,GAAG,CAAC,GAAGhB,OAAO,CAACc,IAAI,CAACE,GAAG,CAAC;MAE7DF,IAAI,CAACG,iBAAiB,GAAGf,IAAI,CAACgB,KAAK,GAAGhB,IAAI,CAACiB,IAAI;MAE/CL,IAAI,CAACM,eAAe,GAAGlB,IAAI,CAACmB,GAAG,GAAGnB,IAAI,CAACiB,IAAI;IAC7C;IAGA,MAAMG,WAA+B,GAAG;MACtCnB,QAAQ,EAAEE,UAAU;MACpBD,IAAI,EACFA,IAAI,KAAK,SAAS,IAAIA,IAAI,KAAK,cAAc,GACzC,CAAC,GACDA,IAAI,KAAK,YAAY,IAAIA,IAAI,KAAK,iBAAiB,GACjD,CAAC,GACD,CAAC;MACTU;IACF,CAAC;IACD,IAAId,OAAO,CAACuB,EAAE,KAAK,IAAI,EAAE;MACvBD,WAAW,CAACC,EAAE,GAAGvB,OAAO,CAACuB,EAAE;IAC7B;IACApC,IAAI,CAACR,QAAQ,CAAC+B,IAAI,CAACY,WAAW,CAAC;EACjC;AACF;AAGA,SAASX,OAAOA,CACda,MAAM,EACNtB,IAAI,EACJf,IAAiB,EACjBH,SAAiB,EACjByC,SAAkB,EAClBC,OAAgB,EACV;EACN,MAAMC,WAAW,GAAG3C,SAAS,GAAGA,SAAS;EAEzC,IAAIA,SAAS,GAAG,CAAC,IAAIkB,IAAI,CAACiB,IAAI,IAAIM,SAAS,GAAGE,WAAW,GAAG3C,SAAS,CAAC,EAAE;IACtEG,IAAI,CAACC,SAAS,IAAIc,IAAI,CAACX,MAAM,GAAG,CAAC;IACjC;EACF;EAEA,MAAMqC,IAAc,GAAG,EAAE;EAEzB,KAAK,IAAInB,CAAC,GAAG,CAAC,EAAEA,CAAC,GAAGP,IAAI,CAACX,MAAM,EAAEkB,CAAC,IAAI,CAAC,EAAE;IACvC,IAAIzB,SAAS,KAAK,CAAC,IAAIkB,IAAI,CAACO,CAAC,GAAG,CAAC,CAAC,GAAGkB,WAAW,EAAE;MAChDxC,IAAI,CAACE,aAAa,EAAE;MACpBuC,IAAI,CAAClB,IAAI,CAACR,IAAI,CAACO,CAAC,CAAC,EAAEP,IAAI,CAACO,CAAC,GAAG,CAAC,CAAC,CAAC;IACjC;IACAtB,IAAI,CAACC,SAAS,EAAE;EAClB;EAEA,IAAIqC,SAAS,EAAEI,MAAM,CAACD,IAAI,EAAEF,OAAO,CAAC;EAEpCF,MAAM,CAACd,IAAI,CAACkB,IAAI,CAAC;AACnB;AAEA,SAASC,MAAMA,CAACD,IAAc,EAAEE,SAAmB,EAAQ;EACzD,IAAIC,IAAI,GAAG,CAAC;EACZ,KAAK,IAAItB,CAAC,GAAG,CAAC,EAAEuB,CAAC,GAAGJ,IAAI,CAACrC,MAAM,GAAG,CAAC,EAAEkB,CAAC,GAAGmB,IAAI,CAACrC,MAAM,EAAEyC,CAAC,GAAGvB,CAAC,EAAEA,CAAC,IAAI,CAAC,EAAE;IACnEsB,IAAI,IAAI,CAACH,IAAI,CAACnB,CAAC,CAAC,GAAGmB,IAAI,CAACI,CAAC,CAAC,KAAKJ,IAAI,CAACnB,CAAC,GAAG,CAAC,CAAC,GAAGmB,IAAI,CAACI,CAAC,GAAG,CAAC,CAAC,CAAC;EAC3D;EACA,IAAID,IAAI,GAAG,CAAC,KAAKD,SAAS,EAAE;IAC1B,KAAK,IAAIrB,CAAC,GAAG,CAAC,EAAEwB,GAAG,GAAGL,IAAI,CAACrC,MAAM,EAAEkB,CAAC,GAAGwB,GAAG,GAAG,CAAC,EAAExB,CAAC,IAAI,CAAC,EAAE;MACtD,MAAMhB,CAAC,GAAGmC,IAAI,CAACnB,CAAC,CAAC;MACjB,MAAMf,CAAC,GAAGkC,IAAI,CAACnB,CAAC,GAAG,CAAC,CAAC;MACrBmB,IAAI,CAACnB,CAAC,CAAC,GAAGmB,IAAI,CAACK,GAAG,GAAG,CAAC,GAAGxB,CAAC,CAAC;MAC3BmB,IAAI,CAACnB,CAAC,GAAG,CAAC,CAAC,GAAGmB,IAAI,CAACK,GAAG,GAAG,CAAC,GAAGxB,CAAC,CAAC;MAC/BmB,IAAI,CAACK,GAAG,GAAG,CAAC,GAAGxB,CAAC,CAAC,GAAGhB,CAAC;MACrBmC,IAAI,CAACK,GAAG,GAAG,CAAC,GAAGxB,CAAC,CAAC,GAAGf,CAAC;IACvB;EACF;AACF"}